<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meri Bus - ड्राइवर ऐप</title>
    <style>
        /* --- START OF CSS --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; user-select: none; }
        .app-container { width: 100%; max-width: 400px; height: 100%; max-height: 812px; background-color: #ffffff; overflow-y: auto; position: relative; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 5px solid #333;}
        .screen { padding: 20px; height: 100%; display: none; flex-direction: column; box-sizing: border-box; animation: fadeIn 0.5s; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 24px; color: #333; margin: 0; }
        .app-logo { width: 80px; height: 80px; border-radius: 20px; margin-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #4CAF50, #81C784); color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-secondary { background: linear-gradient(45deg, #888, #aaa); }
        .route-list { display: flex; flex-direction: column; gap: 10px; }
        .route-list .route-item { background-color: #f9f9f9; padding: 20px; border-radius: 8px; cursor: pointer; border-left: 5px solid #4285F4; transition: background-color 0.3s; font-size: 18px; font-weight: bold; }
        .status-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .status-container p { font-size: 20px; color: #888; margin: 0; }
        .status-container h2 { font-size: 32px; font-weight: bold; margin-top: 10px; }
        .status-container h2.off { color: #d32f2f; }
        .status-container h2.on { color: #4CAF50; }
        .tracking-btn { padding: 25px; font-size: 22px; font-weight: bold; transition: background .3s; }
        .tracking-btn.active { background: linear-gradient(45deg, #d32f2f, #e57373); }
        /* --- END OF CSS --- */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="login-screen" class="screen active">
            <div class="header"><img src="https://assets.stickpng.com/images/580b57fcd9996e24bc43c513.png" alt="Meri Bus Logo" class="app-logo"><h1>ड्राइवर लॉगिन</h1></div>
            <div class="form-group"><label for="driver-id">ड्राइवर आईडी</label><input type="text" id="driver-id" value="RAMU_01"></div>
            <div class="form-group"><label for="password">पासवर्ड</label><input type="password" id="password" value="Ramu@123"></div>
            <button id="login-btn" class="btn">लॉगिन करें</button>
        </div>
        
        <!-- Route Selection Screen -->
        <div id="route-screen" class="screen">
            <div class="header"><h1>अपना रूट चुनें</h1></div>
            <div class="route-list">
                 <div class="route-item" onclick="selectRoute('अनूपगढ़ → नरवाली', 'route_anp_nrw')">अनूपगढ़ → नरवाली</div>
                 <div class="route-item" onclick="selectRoute('नरवाली → अनूपगढ़ (वापसी)', 'route_nrw_anp')">नरवाली → अनूपगढ़ (वापसी)</div>
            </div>
            <button id="logout-btn" class="btn btn-secondary">लॉगआउट</button>
        </div>
        
        <!-- Tracking Screen -->
        <div id="tracking-screen" class="screen">
            <div class="header"><h1 id="tracking-route-name">रूट: [रूट का नाम]</h1></div>
            <div class="status-container"><p>स्टेटस</p><h2 id="tracking-status" class="off">ट्रैकिंग बंद है</h2></div>
            <button id="tracking-btn" class="btn tracking-btn">ट्रैकिंग शुरू करें</button>
            <button id="back-to-routes-btn" class="btn btn-secondary">दूसरा रूट चुनें</button>
        </div>
    </div>

    <script>
        // --- START OF JAVASCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- कॉन्फ़िगरेशन ---
            // <<-- ज़रूरी बदलाव: यह IP एड्रेस आपके Termux सर्वर का होना चाहिए
            const API_BASE_URL = 'http://192.168.31.104:5000/api';
            
            // --- ग्लोबल वेरिएबल्स ---
            let isTracking = false;
            let trackingIntervalId = null;
            let currentDriver = null;
            let selectedRouteId = null;

            // --- DOM Elements ---
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const trackingBtn = document.getElementById('tracking-btn');
            const backToRoutesBtn = document.getElementById('back-to-routes-btn');

            // --- फंक्शन्स ---
            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            }
            
            async function handleLogin() {
                const loginId = document.getElementById('driver-id').value;
                const password = document.getElementById('password').value;
                if (!loginId) return alert('ड्राइवर आईडी डालें');

                try {
                    const response = await fetch(`${API_BASE_URL}/driver/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ loginId, password }),
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        return alert(`लॉगिन फेल: ${data.message}`);
                    }
                    
                    currentDriver = data.driver;
                    alert(`स्वागत है, ${currentDriver.name}!`);
                    showScreen('route-screen');
                } catch (error) {
                    console.error('लॉगिन में समस्या:', error);
                    alert('सर्वर से जुड़ने में समस्या। सुनिश्चित करें कि Termux सर्वर चल रहा है और IP सही है।');
                }
            }

            function handleLogout() {
                if (isTracking) { return alert("लॉगआउट करने से पहले कृपया ट्रैकिंग बंद करें।"); }
                currentDriver = null;
                showScreen('login-screen');
            }

            window.selectRoute = function(routeName, routeId) {
                selectedRouteId = routeId;
                document.getElementById('tracking-route-name').textContent = `रूट: ${routeName}`;
                showScreen('tracking-screen');
            }

            function toggleTracking() {
                isTracking = !isTracking;
                updateTrackingUI();
                
                if (isTracking) {
                    // पहले GPS की असली लोकेशन लें, फिर इंटरवल शुरू करें
                    updateLocationWithRealGPS();
                    trackingIntervalId = setInterval(updateLocationWithRealGPS, 15000); // हर 15 सेकंड
                } else {
                    clearInterval(trackingIntervalId);
                    updateLocation(); // ट्रैकिंग बंद होने की जानकारी (isTrackingActive: false) भेजो
                }
            }
            
            function updateLocationWithRealGPS() {
                if (!navigator.geolocation) {
                    alert("आपका ब्राउज़र GPS लोकेशन को सपोर्ट नहीं करता।");
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // लोकेशन सफलतापूर्वक मिली
                        const coords = [position.coords.longitude, position.coords.latitude];
                        updateLocation(coords);
                    },
                    (error) => {
                        // लोकेशन मिलने में एरर
                        console.error("GPS Error:", error.message);
                        alert(`GPS एरर: ${error.message}\nहम टेस्टिंग के लिए एक नकली लोकेशन भेज रहे हैं।`);
                        // अगर GPS काम न करे तो भी टेस्टिंग चलती रहे
                        updateLocation();
                    }
                );
            }

            async function updateLocation(coordinates = null) {
                if (!currentDriver || !selectedRouteId) return;
                
                let finalCoordinates = coordinates;
                if (!finalCoordinates) {
                    // अगर GPS से लोकेशन नहीं मिली तो नकली लोकेशन बनाओ
                    finalCoordinates = [ 73.2083 + (Math.random() - 0.5) * 0.1, 29.1907 + (Math.random() - 0.5) * 0.1 ];
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/track/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            driverId: currentDriver._id,
                            routeId: selectedRouteId,
                            coordinates: finalCoordinates,
                            isTrackingActive: isTracking
                        }),
                    });
                    const data = await response.json();
                    console.log(`लोकेशन भेजी गई (${isTracking ? 'ON' : 'OFF'}): `, data.message);
                } catch (error) {
                    console.error('लोकेशन भेजने में समस्या:', error);
                    alert("लोकेशन सर्वर पर नहीं भेज पाए। ट्रैकिंग रुक गई है।");
                    // एरर आने पर ट्रैकिंग बंद कर दें
                    isTracking = false; 
                    updateTrackingUI(); 
                    clearInterval(trackingIntervalId);
                }
            }
            
            function updateTrackingUI() {
                const statusText = document.getElementById('tracking-status');
                const trackingBtn = document.getElementById('tracking-btn');
                if (isTracking) {
                    trackingBtn.textContent = 'ट्रैकिंग बंद करें';
                    trackingBtn.classList.add('active');
                    statusText.textContent = 'ट्रैकिंग चालू है';
                    statusText.classList.remove('off');
                    statusText.classList.add('on');
                } else {
                    trackingBtn.textContent = 'ट्रैकिंग शुरू करें';
                    trackingBtn.classList.remove('active');
                    statusText.textContent = 'ट्रैकिंग बंद है';
                    statusText.classList.remove('on');
                    statusText.classList.add('off');
                }
            }

            // --- इवेंट लिस्नर्स ---
            loginBtn.addEventListener('click', handleLogin);
            trackingBtn.addEventListener('click', toggleTracking);
            logoutBtn.addEventListener('click', handleLogout);
            backToRoutesBtn.addEventListener('click', () => {
                if (isTracking) {
                    alert("दूसरा रूट चुनने से पहले कृपया ट्रैकिंग बंद करें।");
                } else {
                    showScreen('route-screen');
                }
            });
        });
        // --- END OF JAVASCRIPT ---
    </script>
</body>
</html>